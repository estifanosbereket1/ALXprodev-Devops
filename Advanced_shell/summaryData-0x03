#!bin/bash

DATA_DIR="pokemon_data"
OUTPUT="pokemon_report.csv"

# Check if directory exists
if [ ! -d "$DATA_DIR" ]; then
  echo "Directory $DATA_DIR not found. Please run the fetch script first."
  exit 1
fi

# Write CSV header
echo "Name,Height (m),Weight (kg)" > "$OUTPUT"

# Initialize temporary file for awk
tmp_file=$(mktemp)

# Loop through each JSON file
for file in "$DATA_DIR"/*.json; do
  # Extract fields using jq
  name=$(jq -r '.name' "$file" | sed 's/.*/\u&/')             # Capitalize first letter
  height=$(jq -r '.height' "$file" | awk '{printf "%.1f", $1/10}')  # decimeters to meters
  weight=$(jq -r '.weight' "$file" | awk '{printf "%.1f", $1/10}')  # hectograms to kg

  # Append to CSV
  echo "$name,$height,$weight" >> "$OUTPUT"

  # Save for awk calculation
  echo "$height $weight" >> "$tmp_file"
done

echo "CSV Report generated at: $OUTPUT"
echo ""

# Print CSV content
cat "$OUTPUT"
echo ""

# Calculate averages using awk
awk '
{h+=$1; w+=$2; n++} 
END {
  if(n > 0){
    printf "Average Height: %.2f m\nAverage Weight: %.2f kg\n", h/n, w/n
  }
}
' "$tmp_file"

# Clean up
rm -f "$tmp_file"
